const svgIconss = {
    gmail: `<svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 100 100" width="100px" height="100px"><polygon fill="#f16e7c" points="29.434,25.293 50,40.657 70.566,25.293 70.566,48 50,63 29.434,48"/><path fill="#ead032" d="M70.566,47.554L87.91,34.849v-4.808c0-5.002-4.055-9.056-9.056-9.056h-2.046l-6.242,4.308	C70.566,25.293,70.566,47.554,70.566,47.554z"/><path fill="#e85654" d="M29.434,47.554L12.089,34.849v-4.808c0-5.002,4.055-9.056,9.056-9.056h2.046l6.242,4.308	L29.434,47.554L29.434,47.554z"/><path fill="#8cc78c" d="M70,48l18.362-13.638v38.926c0,3.155-2.557,5.712-5.712,5.712H70V48z"/><path fill="#40a6dd" d="M30,48L11.638,34.362v38.926c0,3.155,2.557,5.712,5.712,5.712H30V48z"/><path fill="#1f212b" d="M78.99,20c-2.186,0-4.265,0.695-6.012,2.011L50,39.328L27.021,22.011C25.274,20.695,23.195,20,21,20	c-5.514,0-10,4.486-10,10v44c0,3.309,2.691,6,6,6h13c0.553,0,1-0.447,1-1V50.092L49.4,63.8c0.18,0.13,0.39,0.2,0.6,0.2	s0.41-0.06,0.59-0.19L69,50.514V79c0,0.553,0.447,1,1,1h13c3.309,0,6-2.691,6-6V30C89,24.486,84.514,20,78.99,20z M74.182,23.608	C75.579,22.557,77.242,22,79,22c4.411,0,8,3.589,8,8v4.799L71,46.724V46.6V26.006L74.182,23.608z M21.01,22	c1.748,0,3.411,0.557,4.809,1.608L29,26.006V46.6v0.124L13,34.799V30C13,25.589,16.589,22,21.01,22z M29,78H17c-2.206,0-4-1.794-4-4	V36.047l16,11.924v0.823V49V78z M50.01,61.76L30,47.322V26.76l19.398,14.619c0.017,0.013,0.037,0.015,0.054,0.026	c0.059,0.039,0.122,0.064,0.187,0.089c0.057,0.022,0.111,0.047,0.17,0.059c0.066,0.013,0.13,0.011,0.197,0.01	c0.061,0,0.12,0.002,0.18-0.009c0.062-0.012,0.12-0.038,0.18-0.062c0.063-0.025,0.124-0.049,0.181-0.087	c0.017-0.011,0.037-0.013,0.054-0.026L70,26.76v20.562L50.01,61.76z M83,78H71V49.07v-0.174V48.5v-0.528l16-11.924V74	C87,76.206,85.206,78,83,78z"/><path fill="#1f212b" d="M16.5,61c0.276,0,0.5-0.224,0.5-0.5v-2c0-0.276-0.224-0.5-0.5-0.5S16,58.224,16,58.5v2	C16,60.776,16.224,61,16.5,61z"/><path fill="#1f212b" d="M16.5,52c0.276,0,0.5-0.224,0.5-0.5v-7c0-0.276-0.224-0.5-0.5-0.5S16,44.224,16,44.5v7	C16,51.776,16.224,52,16.5,52z"/><path fill="#1f212b" d="M24.5,74h-7c-0.275,0-0.5-0.225-0.5-0.5v-10c0-0.276-0.224-0.5-0.5-0.5S16,63.224,16,63.5v10	c0,0.827,0.673,1.5,1.5,1.5h7c0.276,0,0.5-0.224,0.5-0.5S24.776,74,24.5,74z"/><path fill="#1f212b" d="M42.801,40.16c-0.22-0.164-0.532-0.123-0.7,0.099c-0.166,0.221-0.122,0.534,0.099,0.7l2.047,1.542	c0.09,0.067,0.195,0.101,0.301,0.101c0.151,0,0.301-0.068,0.399-0.199c0.166-0.221,0.122-0.534-0.099-0.7L42.801,40.16z"/><path fill="#1f212b" d="M46.444,42.905c-0.219-0.164-0.533-0.123-0.7,0.099c-0.166,0.221-0.122,0.534,0.099,0.7l2.914,2.195	C48.847,45.967,48.952,46,49.058,46c0.151,0,0.301-0.068,0.399-0.199c0.166-0.221,0.122-0.534-0.099-0.7L46.444,42.905z"/><path fill="#1f212b" d="M55.306,41.587l-3.337,2.514c-0.221,0.166-0.265,0.479-0.099,0.7C51.969,44.932,52.118,45,52.27,45	c0.105,0,0.211-0.033,0.301-0.101l3.337-2.514c0.221-0.166,0.265-0.479,0.099-0.7C55.839,41.464,55.524,41.423,55.306,41.587z"/><path fill="#1f212b" d="M58.682,39.044l-1.778,1.339c-0.221,0.166-0.265,0.479-0.099,0.7	c0.099,0.131,0.248,0.199,0.399,0.199c0.105,0,0.211-0.033,0.301-0.101l1.778-1.339c0.221-0.166,0.265-0.479,0.099-0.7	C59.215,38.92,58.9,38.88,58.682,39.044z"/><path fill="#1f212b" d="M66.899,33.479c-0.167-0.222-0.481-0.263-0.7-0.099l-5.919,4.46c-0.221,0.166-0.265,0.479-0.099,0.7	c0.099,0.131,0.248,0.199,0.399,0.199c0.105,0,0.211-0.033,0.301-0.101l5.919-4.459C67.021,34.014,67.065,33.7,66.899,33.479z"/><path fill="#1f212b" d="M16.5,56c0.276,0,0.5-0.224,0.5-0.5v-1c0-0.276-0.224-0.5-0.5-0.5S16,54.224,16,54.5v1	C16,55.776,16.224,56,16.5,56z"/></svg>`,
    sheets: `<svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 100 100" width="100px" height="100px"><path fill="#70b570" d="M59.5,12H27c-2.761,0-5,2.239-5,5v66c0,2.761,2.239,5,5,5h46c2.761,0,5-2.239,5-5V30.5L59.5,12z"/><path fill="#8cc78c" d="M59.5,11.5V25c0,3.038,2.462,5.5,5.5,5.5h13.5L59.5,11.5z"/><path fill="#1f212b" d="M73,89H27c-3.309,0-6-2.691-6-6V17c0-3.309,2.691-6,6-6h32.5c0.266,0,0.52,0.105,0.707,0.293 l18.5,18.5C78.895,29.98,79,30.235,79,30.5V83C79,86.309,76.309,89,73,89z M27,13c-2.206,0-4,1.794-4,4v66c0,2.206,1.794,4,4,4h46 c2.206,0,4-1.794,4-4V30.914L59.086,13H27z"/><path fill="#1f212b" d="M78.5,31H65c-3.309,0-6-2.691-6-6V11.5h1V25c0,2.757,2.243,5,5,5h13.5V31z"/><path fill="#1f212b" d="M26.5,41c-0.276,0-0.5-0.224-0.5-0.5v-22c0-1.378,1.121-2.5,2.5-2.5h15c0.276,0,0.5,0.224,0.5,0.5 S43.776,17,43.5,17h-15c-0.827,0-1.5,0.673-1.5,1.5v22C27,40.776,26.776,41,26.5,41z"/><path fill="#1f212b" d="M71.5,84h-11c-0.276,0-0.5-0.224-0.5-0.5s0.224-0.5,0.5-0.5h11c0.827,0,1.5-0.673,1.5-1.5v-6 c0-0.276,0.224-0.5,0.5-0.5s0.5,0.224,0.5,0.5v6C74,82.878,72.879,84,71.5,84z"/><path fill="#1f212b" d="M73.5,73c-0.276,0-0.5-0.224-0.5-0.5v-32c0-0.276,0.224-0.5,0.5-0.5s0.5,0.224,0.5,0.5v32 C74,72.776,73.776,73,73.5,73z"/><path fill="#fefdef" d="M66.5,46.5h-33v28h33V46.5z M37.5,50.5H48v4H37.5V50.5z M52,50.5h10.5v4H52V50.5z M37.5,58.5H48v4 H37.5V58.5z M52,58.5h10.5v4H52V58.5z M37.5,66.5H48v4H37.5V66.5z M52,66.5h10.5v4H52V66.5z"/><path fill="#1f212b" d="M66.5,75h-33c-0.276,0-0.5-0.224-0.5-0.5v-28c0-0.276,0.224-0.5,0.5-0.5h33 c0.276,0,0.5,0.224,0.5,0.5v28C67,74.776,66.776,75,66.5,75z M34,74h32V47H34V74z"/><path fill="#1f212b" d="M48,55H37.5c-0.276,0-0.5-0.224-0.5-0.5v-4c0-0.276,0.224-0.5,0.5-0.5H48c0.276,0,0.5,0.224,0.5,0.5 v4C48.5,54.776,48.276,55,48,55z M38,54h9.5v-3H38V54z"/><path fill="#1f212b" d="M62.5,55H52c-0.276,0-0.5-0.224-0.5-0.5v-4c0-0.276,0.224-0.5,0.5-0.5h10.5 c0.276,0,0.5,0.224,0.5,0.5v4C63,54.776,62.776,55,62.5,55z M52.5,54H62v-3h-9.5V54z"/><path fill="#1f212b" d="M48,63H37.5c-0.276,0-0.5-0.224-0.5-0.5v-4c0-0.276,0.224-0.5,0.5-0.5H48c0.276,0,0.5,0.224,0.5,0.5 v4C48.5,62.776,48.276,63,48,63z M38,62h9.5v-3H38V62z"/><path fill="#1f212b" d="M62.5,63H52c-0.276,0-0.5-0.224-0.5-0.5v-4c0-0.276,0.224-0.5,0.5-0.5h10.5 c0.276,0,0.5,0.224,0.5,0.5v4C63,62.776,62.776,63,62.5,63z M52.5,62H62v-3h-9.5V62z"/><path fill="#1f212b" d="M48,71H37.5c-0.276,0-0.5-0.224-0.5-0.5v-4c0-0.276,0.224-0.5,0.5-0.5H48c0.276,0,0.5,0.224,0.5,0.5 v4C48.5,70.776,48.276,71,48,71z M38,70h9.5v-3H38V70z"/><path fill="#1f212b" d="M62.5,71H52c-0.276,0-0.5-0.224-0.5-0.5v-4c0-0.276,0.224-0.5,0.5-0.5h10.5 c0.276,0,0.5,0.224,0.5,0.5v4C63,70.776,62.776,71,62.5,71z M52.5,70H62v-3h-9.5V70z"/><path fill="#1f212b" d="M57.5,84h-5c-0.276,0-0.5-0.224-0.5-0.5s0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5 S57.776,84,57.5,84z"/><path fill="#1f212b" d="M26.5,55c-0.276,0-0.5-0.224-0.5-0.5v-11c0-0.276,0.224-0.5,0.5-0.5s0.5,0.224,0.5,0.5v11 C27,54.776,26.776,55,26.5,55z"/><path fill="#1f212b" d="M26.5,61c-0.276,0-0.5-0.224-0.5-0.5v-3c0-0.276,0.224-0.5,0.5-0.5s0.5,0.224,0.5,0.5v3 C27,60.776,26.776,61,26.5,61z"/></svg>`
};

function generateRandomStr(length) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

async function getSpreadsheets(google_token) {
    const response = await fetch(
        'https://www.googleapis.com/drive/v3/files?' +
        'q=' + encodeURIComponent('mimeType="application/vnd.google-apps.spreadsheet" and trashed=false') +
        '&fields=files(id,name)', {
            headers: {
                'Authorization': `Bearer ${google_token}`
            }
        }
    );
    const data = await response.json();
    console.log('DATA', data);
    return data.files;
}

async function showModal() {
    const result_token = await chrome.storage.local.get(['accessToken']);
    console.log('resToken', result_token);
    const token = result_token.accessToken;
    console.log('token', token);
    // Получение токенов
    console.log("RESSSSSPONSE");
    const googleTokenResponse = await fetch('http://127.0.0.1:8000/api/v1/get_google_token', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`
        }
    });
    const data = await googleTokenResponse.json();
    const googleToken = data["google_access_token"];
    console.log('googleToken', googleToken);
    const files = await getSpreadsheets(googleToken);
    await showInsertModalForm1(files);
}

async function getEmailsFromGoogleSheet(spreadsheetId, range) {
    const result_token = await chrome.storage.local.get(['accessToken']);
    console.log('resToken', result_token);
    const token = result_token.accessToken;
    console.log('token', token);
    const response = await fetch('http://127.0.0.1:8000/api/v1/get-emails', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            spreadsheet_id: spreadsheetId,
            range: range
        }),
    });

    if (response.ok) {
        const data = await response.json();
        const uniqueId = generateRandomStr(7);
        const name = data.spreadsheet_name;
        const emails = data.emails;
        chrome.storage.local.set({ [uniqueId]: { sheetName: name, realEmails: emails } }, function() { 
            console.log('Sheet data saved with ID:', uniqueId);
        });
        return [emails, uniqueId];
    } else {
        console.error('Failed to fetch emails');
        return [];
    }
}

async function handleEmailSending() {
    const select = document.getElementById('selectGoogleSheetId');
    const spreadsheetId = select.value;
    const range = "A1:A1000";  // Диапазон, где содержатся email-адреса
    const data = await getEmailsFromGoogleSheet(spreadsheetId, range);
    
    await openNewMessageInGmail(data);
}

async function showInsertModalForm1(files) {
    const spec_window = document.getElementById("spec_window");
    if (spec_window) {
        return;
    }

    const overlay = document.createElement("div");
    overlay.style.cssText = `
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        z-index: 99999999999999;
        background-color: rgba(0, 0, 0, 0.5);
        display: grid;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(3px);
    `;
    overlay.id = "spec_window";
    overlay.classList.add("spec_window");

    const spec_window_container = document.createElement("div");
    spec_window_container.style.cssText = `
        max-width: 500px;
        width: 90%;
        padding: 40px;
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        text-align: center;
        animation: slideDown 0.3s ease-out;
    `;
    
    // Добавляем анимацию
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    spec_window_container.id = "spec_window_container";
    spec_window_container.classList.add("spec_window_container");
    
    const h3 = document.createElement("h3");
    h3.textContent = "Choose GoogleSheet below";
    h3.style.cssText = `
        font-size: 24px;
        color: #333;
        margin-bottom: 30px;
        font-weight: 500;
    `;

    // Контейнер для логотипов
    const container = document.createElement("div");
    container.style.cssText = `
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 30px;
        margin-bottom: 30px;
    `;

    const logo1 = document.createElement("img");
    const logo2 = document.createElement("img");
    
    // Стили для логотипов
    const logoStyle = `
        width: 50px;
        height: 50px;
        transition: transform 0.3s ease;
        cursor: pointer;
    `;
    
    logo1.style.cssText = logoStyle;
    logo2.style.cssText = logoStyle;
    
    // Добавляем эффект при наведении
    logo1.onmouseover = () => logo1.style.transform = 'scale(1.1)';
    logo1.onmouseout = () => logo1.style.transform = 'scale(1)';
    logo2.onmouseover = () => logo2.style.transform = 'scale(1.1)';
    logo2.onmouseout = () => logo2.style.transform = 'scale(1)';

    const svgBlob1 = new Blob([svgIconss['sheets']], { type: 'image/svg+xml' });
    const svgUrl1 = URL.createObjectURL(svgBlob1);
    logo1.src = svgUrl1;

    const svgBlob2 = new Blob([svgIconss['gmail']], { type: 'image/svg+xml' });
    const svgUrl2 = URL.createObjectURL(svgBlob2);
    logo2.src = svgUrl2;

    container.appendChild(logo1);
    container.appendChild(logo2);

    const p = document.createElement("p");
    p.textContent = "You haven't any GoogleSheets...";
    p.style.ccsText = `
        font-size: 18px;
        color: #333;
        margin-bottom: 30px;
        font-weight: 400;
    `;

    const form = document.createElement("form");
    form.style.cssText = `
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 100%;
    `;
    
    const select = document.createElement("select");
    select.name = "selectGoogleSheet";
    select.id = "selectGoogleSheetId";
    select.style.cssText = `
        padding: 12px 15px;
        border: 2px solid #e1e1e1;
        border-radius: 8px;
        font-size: 16px;
        color: #333;
        background-color: #f8f9fa;
        cursor: pointer;
        outline: none;
        transition: all 0.3s ease;
        width: 100%;
    `;
    
    select.onmouseover = () => select.style.borderColor = '#007bff';
    select.onmouseout = () => select.style.borderColor = '#e1e1e1';
    
    for (const file of files) {
        const option = document.createElement("option");
        option.value = file.id;
        option.textContent = file.name;
        select.appendChild(option);
    }

    const submitButton = document.createElement("button");
    submitButton.type = "submit";
    submitButton.textContent = "Submit";
    submitButton.style.cssText = `
        padding: 12px 25px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
    `;
    
    submitButton.onmouseover = () => {
        submitButton.style.backgroundColor = '#0056b3';
        submitButton.style.transform = 'translateY(-2px)';
    };
    submitButton.onmouseout = () => {
        submitButton.style.backgroundColor = '#007bff';
        submitButton.style.transform = 'translateY(0)';
    };

    spec_window_container.appendChild(container);
    spec_window_container.appendChild(h3);

    if (files.length === 0) {
        spec_window_container.appendChild(p);
    } else {
        form.appendChild(select);
        form.appendChild(submitButton);
        spec_window_container.appendChild(form);
    }

    overlay.appendChild(spec_window_container);
    document.body.appendChild(overlay);

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleEmailSending();

        overlay.remove();
        style.remove();
    });

    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            overlay.remove();
            style.remove();
        }
    });
}

async function openNewMessageInGmail(data) {
    // Нажимаем кнопку "Написать" программно
    const emailAddresses = data[0];
    const id = data[1];
    const composeButton = document.querySelector('.T-I.T-I-KE.L3');
    if (composeButton) {
        composeButton.click();

        // Ждем, пока откроется окно нового сообщения и находим именно его
        setTimeout(async () => {
            // Получаем все окна композиции
            const composeWindows = document.querySelectorAll('.AD');
            // Берем последнее открытое окно (новое)
            const newComposeWindow = composeWindows[composeWindows.length - 1];
            
            if (newComposeWindow) {
                console.log('Было найдено!');
                
                // Передаем конкретное окно в функцию добавления чипа
                addEmailChip(id, emailAddresses.length, newComposeWindow);
            } else {
                console.log('Не было найдено!');
                // Передаем конкретное окно в функцию добавления чипа
                addEmailChip(id, emailAddresses.length, document);
            }
        }, 500);
    }
}

function addCustomRecipient2(emails) {
    // Находим контейнер поля "Кому"
    const recipientContainer = document.querySelector('.agP.aFw');
    if (!recipientContainer) {
        console.log("Поле 'Кому' не найдено");
        return;
    }
    console.log(emails);
    emails.forEach(email => {
        // Добавляем почту в поле ввода
        const emailToAdd = email;
        recipientContainer.value = emailToAdd;

        // Генерируем событие "ввода", чтобы Gmail обработал добавленный адрес
        const inputEvent = new Event('input', { bubbles: true });
        recipientContainer.dispatchEvent(inputEvent);

        // Генерируем событие "Enter", чтобы Gmail создал "чип"
        const keyboardEvent = new KeyboardEvent('keydown', {
            bubbles: true,
            cancelable: true,
            key: 'Enter',
            code: 'Enter',
        });
        recipientContainer.dispatchEvent(keyboardEvent);
        console.log(email, emailToAdd);
    });
}

function addEmailChip(sheetName, len, composeWindow) {
    // Получаем поле ввода получателей
    recipientField = composeWindow.querySelector('.agP.aFw');
    
    if (!recipientField) {
      console.error('Поле получателей не найдено');
      return false;
    }
  
    // Сохраняем текущий фокус
    const activeElement = document.activeElement;
    
    // Устанавливаем фокус на поле получателей
    recipientField.focus();
    
    // Эмулируем ввод email
    const emailString = `${len}-recipients-id_${sheetName}@quicksend.com`;
    
    // Устанавливаем значение
    recipientField.value = emailString;
    
    // Создаем и диспатчим события для корректной обработки Gmail
    const events = [
      new InputEvent('input', { bubbles: true }),
      new KeyboardEvent('keydown', { 
        bubbles: true, 
        cancelable: true, 
        keyCode: 13, // Enter
        which: 13
      })
    ];
    
    events.forEach(event => {
      recipientField.dispatchEvent(event);
    });
    
    // Восстанавливаем предыдущий фокус
    if (activeElement) {
      activeElement.focus();
    }
    
    return true;
  }
  

function addCustomRecipient3(emails) {
    // Находим контейнер поля "Кому"
    const recipientContainer = document.querySelector('.agP.aFw');
    if (!recipientContainer) {
        console.log("Поле 'Кому' не найдено");
        return;
    }
    console.log(emails);

    // Перебираем все emails и добавляем их по очереди
    emails.forEach(email => {
        // Получаем текущее значение поля ввода
        const currentValue = recipientContainer.value;

        // Добавляем новый email (через разделитель, например, пробел)
        recipientContainer.value = currentValue + (currentValue ? ' ' : '') + email;
        console.log('Текущее значение поля ввода: ', recipientContainer.value);

        // Делаем фокус на поле ввода
        recipientContainer.focus();

        // Генерируем событие "ввода", чтобы Gmail обработал добавленный адрес
        const inputEvent = new Event('input', { bubbles: true });
        recipientContainer.dispatchEvent(inputEvent);

        // Добавляем небольшую задержку перед отправкой события "Enter"
        setTimeout(() => {
            // Генерируем событие "Enter", чтобы Gmail создал "чип"
            const keyboardEvent = new KeyboardEvent('keydown', { 
                bubbles: true, 
                cancelable: true, 
                keyCode: 13, // Enter
                which: 13
              });
            recipientContainer.dispatchEvent(keyboardEvent);

            console.log('Добавлен новый email:', email);
        }, 300);  // Задержка 300 миллисекунд
    });
}

function addCustomRecipient4(emails) {
    const recipientInput = document.querySelector('.agP.aFw');

    if (!recipientInput) {
        console.error('Поле получателей не найдено');
        return;
    }

    // Function to add a single email with proper events
    function addSingleEmail(email) {
        return new Promise((resolve) => {
            // Focus the input
            recipientInput.focus();
            
            // Set the value
            recipientInput.value = email;
            
            // Trigger input event
            recipientInput.dispatchEvent(new Event('input', { bubbles: true }));
            
            // Small delay to let Gmail process the input
            setTimeout(() => {
                // Trigger Enter key
                recipientInput.dispatchEvent(new KeyboardEvent('keydown', {
                    bubbles: true,
                    cancelable: true,
                    keyCode: 13,
                    which: 13,
                    key: 'Enter'
                }));
                
                // Clear the input for the next email
                recipientInput.value = '';
                
                resolve();
            }, 100);
        });
    }

    // Add emails one by one with delays
    async function addEmailsSequentially() {
        for (const email of emails) {
            await addSingleEmail(email);
            // Wait between additions
            await new Promise(resolve => setTimeout(resolve, 200));
        }
    }

    addEmailsSequentially();
}

function addCustomRecipient(composeWindow, email) {
    // Находим контейнер для получателей
    const recipientContainer = document.getElementsByClassName('agP')[0];
    if (!recipientContainer) {
        console.log("NOOOO !recipientContainer");
        return;
    }

    // Находим контейнер с чипами получателей
    /*const chipsContainer = recipientContainer.querySelector('div[role="listbox"]');
    if (!chipsContainer) {
        console.log("NOOOO !chipsContainer");
        return;
    };*/

    // Создаем элемент получателя в стиле Gmail
    const recipientChip = document.createElement('div');
    recipientChip.className = 'afV'; // Базовый класс Gmail для получателей
    recipientChip.setAttribute('role', 'option');
    recipientChip.style.display = 'inline-flex';
    recipientChip.style.alignItems = 'center';
    recipientChip.style.backgroundColor = '#eef3fc';
    recipientChip.style.borderRadius = '12px';
    recipientChip.style.margin = '2px';
    recipientChip.style.maxWidth = '100%';
    recipientChip.style.padding = '0 4px 0 8px';

    // Добавляем email
    const emailSpan = document.createElement('span');
    emailSpan.className = 'vs';
    emailSpan.textContent = email;
    emailSpan.style.color = '#041e49';
    emailSpan.style.fontSize = '14px';
    emailSpan.style.lineHeight = '24px';

    // Добавляем крестик для удаления
    const removeButton = document.createElement('div');
    removeButton.className = 'ast';
    removeButton.innerHTML = '×';
    removeButton.style.cursor = 'pointer';
    removeButton.style.color = '#666';
    removeButton.style.fontSize = '18px';
    removeButton.style.marginLeft = '4px';
    removeButton.style.padding = '0 4px';
    
    // Обработчик для удаления получателя
    removeButton.addEventListener('click', (e) => {
        e.stopPropagation();
        recipientChip.remove();
    });

    // Собираем элемент получателя
    recipientChip.appendChild(emailSpan);
    recipientChip.appendChild(removeButton);

    // Добавляем в контейнер
    recipientContainer.appendChild(recipientChip);
}

window.addEventListener('load', () => {
    setTimeout(async () => {
        const btn = document.getElementById('table-button');
        btn.addEventListener('click', async () => {
            await showModal();
        });
    }, 6000);
    const msg = document.querySelector(".nH.Hd");
    msg.addEventListener('keypress', function(event) {
        console.log('БЫЛ ПОВЕШЕН ОБРАБОТЧИК');
        console.log(event.key);
        // Проверяем, был ли нажат Enter
        if (event.key === 'Enter') {
            event.preventDefault();
            event.stopPropagation();
            // Получаем элемент, на котором произошло событие
            const targetElement = event.target;
            
            // Выводим информацию о целевом элементе
            console.log('Enter был нажат на элементе:', targetElement);
            console.log('Тип элемента:', targetElement.tagName);
            console.log('Класс элемента:', targetElement.className);
        }
    });
    
});
